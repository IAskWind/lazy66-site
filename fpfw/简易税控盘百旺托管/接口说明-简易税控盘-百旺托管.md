# 接口说明-简易税控盘-百旺托管

### 调用方式地址

- 测试地址： http://124.205.255.18:8003/opweb/openapi

- 正式地址：[https://lazy.holytax.com/opweb/openapi](https://lazy.holytax.com/opweb/openapi)

  

### 公共参数说明

| 索引 |     ID      |     名称     | 必须 | 说明                                   |
| :--: | :---------: | :----------: | :--: | -------------------------------------- |
|  1   |   app_key   |   app_key    |  是  | 接口提供方提供                         |
|  2   |   method    |    接口名    |  是  | 根据调用方法传入具体值                 |
|  3   |   version   |   接口版本   |  是  | 1.0                                    |
|  4   | format_type |   请求格式   |  是  | xml                                    |
|  5   |  sign_type  | sign编码方式 |  是  | md5                                    |
|  6   |  timestamp  |   请求时间   |  是  | 格式：yyyy-MM-dd HH:mm:ss 20分钟内有效 |
|  7   | biz_content |   业务参数   |  是  | 根据调用方法传入具体的业务值           |
|  8   |    sign     |     sign     |  是  | 具体sign算法，参考sign说明             |

  ### sign算法说明

用户需要告知接口提供方，纳税人名称 纳税人识别号 申请人姓名 申请人手机号码4要素。接口提供会给用户提供

- app_key
- app_secret

用户把公共参数，包括app_secret 组成map（不包括sign），按照key升序排序，排序完，去对应的value，组成字符串，然后md5就是sign值。

示例：里面用的库 [Hutool](https://www.hutool.cn/docs/#/)库


```java
/**
	 * 按参数排序取value的值拼接在一起
	 *
	 * @param sortedParams
	 * @return
	 */
	public String getSignContent(Map<String, String> sortedParams) {
		//移除这个
		sortedParams.remove(OpenApiConstant.SIGN);
		StringBuilder content = new StringBuilder();
		List<String> keys = new ArrayList<>(sortedParams.keySet());
		Collections.sort(keys);
		for (String key : keys) {
			String value =sortedParams.get(key);
			content.append(value);
		}
		return content.toString();
	}

/**
	 * md5加密
	 *
	 * @param content
	 * @return
	 */
	public String md5Sign(String content) {
		return SecureUtil.md5(content);
	}
```



### 调用demo

```java
    private static final String APP_KEY = "";
    private static final String APP_SECRET = "";
    private static final String URL_JYSKP = "";

    String method = "lazy.opweb.bwtg.jyskpapi.hqkpm";
    String biz_Content = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n" +
                "<business comment=\"获取开票码\" id=\"HQKPM\" version='2.0'>\n" +
                "    <body yylxdm=\"1\">\n" +
                "        <input>\n" +
                "          <nsrsbh>纳税人识别号</nsrsbh>\n" +
                "          <kpm>开票码</kpm>\n" +
                "        </input>\n" +
                "    </body>\n" +
                "</business>";


		Map<String, String> paraMap = new HashMap<>();
        paraMap.put(OpenApiConstant.APP_KEY, APP_KEY);
        paraMap.put(OpenApiConstant.METHOD, method);
        paraMap.put(OpenApiConstant.VERSION, "1.0");
        paraMap.put(OpenApiConstant.FORMAT_TYPE, "xml");
        paraMap.put(OpenApiConstant.SIGN_TYPE, "md5");
        paraMap.put(OpenApiConstant.TIMESTAMP, DateUtil.now());
        paraMap.put(OpenApiConstant.BIZ_CONTENT, biz_Content);
        paraMap.put(OpenApiConstant.APP_SECRET, APP_SECRET);
        String content = SignKit.getSignContent(paraMap);
        String signMd5 = SignKit.md5Sign(content);
        log.info("sign:" + signMd5);
        paraMap.put(OpenApiConstant.SIGN, signMd5);
        paraMap.remove(OpenApiConstant.APP_SECRET);
        String ret = HttpUtil.post(URL_JYSKP, HttpUtil.toParams(paraMap));
        log.info("ret:" + ret);


```



### 接口返回参数说明
```json
{
	"code":200,
  	"msg":"请求成功",
 	"data":"<?xml version=\"1.0\" encoding=\"utf-8\"?><business 			id=\"GETKPM\"><body><returncode>0</returncode><returnmsg>MTEwMTAxMjAxNjAxMDEwMDk3MjAxOTEwMjMxNjEzMzY5NTY3NDUwNA==</returnmsg></body></business>"
 }
```

| 索引 |  ID  |        名称        | 必须 | 说明                                    |
| :--: | :--: | :----------------: | :--: | --------------------------------------- |
|  1   | code |        编码        |  是  | 200请求成功，400 请求失败  500 请求异常 |
|  2   | msg  |      请求msg       |  是  |                                         |
|  3   | data | 税控返回具体的报文 |  是  |                                         |

### 税控错误码

| 1    | 99     | 接口调用异常                                                 |
| ---- | ------ | ------------------------------------------------------------ |
| 2    | 100002 | 入库失败                                                     |
| 3    | 100003 | xml解析失败                                                  |
| 4    | 100005 | map转化成bean失败                                            |
| 5    | 100006 | 更新数据库失败                                               |
| 6    | 100007 | 该设备不在线                                                 |
| 7    | 100008 | 阿里消息推送失败,请联系管理员                                |
| 8    | 100009 | 云票打印机网络异常，请检查                                   |
| 9    | 100010 | 云票打印机处理异常                                           |
| 10   | 100011 | 无访问权限                                                   |
| 11   | 200001 | 有可用授权码，请勿重复授权                                   |
| 12   | 200002 | 授权状态有误                                                 |
| 13   | 200003 | 授权码处于禁用状态                                           |
| 14   | 200004 | 没有可用授权码                                               |
| 15   | 200005 | 授权码已过期                                                 |
| 16   | 200006 | 该授权码不可用                                               |
| 17   | 200007 | 客户名称过长                                                 |
| 18   | 200008 | 该设备不在此平台管辖下                                       |
| 19   | 200009 | 该机身编号已存在                                             |
| 20   | 200010 | 校验状态有误                                                 |
| 21   | 200011 | 该纳税人识别号已存在                                         |
| 22   | 200012 | 该电子平台已存在                                             |
| 23   | 200013 | 该IP已在白名单中                                             |
| 24   | 200014 | 与百旺电子平台通信失败                                       |
| 25   | 200015 | 该企业已注册                                                 |
| 26   | 200016 | 纳税主体，税号与纳税资质不能为空                             |
| 27   | 200017 | 有可用注册码，请勿重复添加                                   |
| 28   | 300000 | 字段格式校验(返回信息为具体字段的具体错误)                   |
| 29   | 300001 | 传入id有误                                                   |
| 30   | 300002 | 此机身编号无对应信息                                         |
| 31   | 300003 | 发票类型代码有误                                             |
| 32   | 300004 | 获取操作结果失败，请调用相应接口查询当前操作结果或稍后查询   |
| 33   | 300005 | 发票代码长度有误                                             |
| 34   | 300006 | 发票请求流水号重复                                           |
| 35   | 300007 | 收款人过长                                                   |
| 36   | 300008 | 复核人过长                                                   |
| 37   | 300009 | 开票人过长                                                   |
| 38   | 300010 | 备注中包含非法字符                                           |
| 39   | 300011 | 备注长度过长                                                 |
| 40   | 300012 | 负数发票扣除额应当为空                                       |
| 41   | 300013 | 负数发票原发票代码格式有误                                   |
| 42   | 300014 | 负数发票原发票号码格式有误                                   |
| 43   | 300015 | 负数发票不能带清单                                           |
| 44   | 300016 | 实际明细行数与count值不一致                                  |
| 45   | 300017 | 发票明细数过多                                               |
| 46   | 300018 | 无清单，明细不得超过8行                                      |
| 47   | 300019 | 发票行性质有误                                               |
| 48   | 300020 | 第一行不能为折扣行                                           |
| 49   | 300021 | 折扣行的金额和税额必须为负                                   |
| 50   | 300022 | 折扣行的规格型号、单位、单价和数量必须为空                   |
| 51   | 300023 | 下一行为折扣行，本行应该为被折扣行                           |
| 52   | 300024 | 折扣行与被折扣行商品名称，税率与含税标志，商品编码相关字段必须一致 |
| 53   | 300025 | 负数发票金额必须为负                                         |
| 54   | 300026 | 明细金额不能为0                                              |
| 55   | 300027 | 负数发票的征税方式与已开正数发票不符                         |
| 56   | 300028 | 负票的金额不能大于未开负数金额                               |
| 57   | 300029 | 负票的税额不能大于未开负数税额                               |
| 58   | 300030 | 正数发票金额不能为负                                         |
| 59   | 300031 | 该商品零税率标识不为空，税率应当为0                          |
| 60   | 300032 | 负数发票不带折扣                                             |
| 61   | 300033 | 购货单位名称不能为空                                         |
| 62   | 300034 | 购货单位名称过长                                             |
| 63   | 300035 | 购货单位地址电话过长                                         |
| 64   | 300036 | 购货单位银行账号过长                                         |
| 65   | 300037 | 销货单位名称过长，请维护                                     |
| 66   | 300038 | 销货单位地址电话为空或过长，请维护                           |
| 67   | 300039 | 销货单位银行账号为空或过长，请维护                           |
| 68   | 300040 | 商品名称过长                                                 |
| 69   | 300041 | 商品税目过长                                                 |
| 70   | 300042 | 规格型号过长                                                 |
| 71   | 300043 | 单位过长                                                     |
| 72   | 300044 | 含税单价有误                                                 |
| 73   | 300045 | 含税金额有误                                                 |
| 74   | 300046 | 商品数量有误                                                 |
| 75   | 300047 | 价税合计有误                                                 |
| 76   | 300048 | 明细合计金额之和与总合计金额不等                             |
| 77   | 300049 | 明细税额之和与总税额不等                                     |
| 78   | 300050 | 不含税金额+税额与含税金额不相等                              |
| 79   | 300051 | 不含税金额*税率与税额误差大于0.06                            |
| 80   | 300052 | 数量*不含税单价与不含税金额误差大于0.01                      |
| 81   | 300053 | 数量*单价与金额误差大于0.01                                  |
| 82   | 300054 | 数量与单价不符合要求(同时为空或同时非空)                     |
| 83   | 300055 | 差额征税只能有一条明细行                                     |
| 84   | 300056 | 差额征税不能带清单                                           |
| 85   | 300057 | 差额征税扣除额有误                                           |
| 86   | 300058 | 差额征税税率不能为0.015和0.05                                |
| 87   | 300059 | 差额征税含税标志必须为0                                      |
| 88   | 300060 | 差额征税扣除额不能大于价税合计                               |
| 89   | 300061 | 差额征税：(价税合计-扣除额)*税率/(1+税率)与税额不等          |
| 90   | 300062 | 开票码节点缺失或为空                                         |
| 91   | 300063 | 开票码不匹配                                                 |
| 92   | 300064 | 开票码不可用，请重新获取开票码                               |
| 93   | 300065 | 电子平台返回电子签章不可用                                   |
| 94   | 300066 | 行号与实际不符                                               |
| 95   | 300067 | 该商品无可用商品编码                                         |
| 96   | 300068 | 该商品有多个可用商品编码，请维护                             |
| 97   | 300069 | 该商品税率不在可用税率范围内                                 |
| 98   | 300070 | 价税合计和合计金额不能为0                                    |
| 99   | 300071 | 折扣金额不得大于被折扣金额                                   |
| 100  | 300072 | 没有此条业务信息                                             |
| 101  | 300073 | 查询条件有误                                                 |
| 102  | 300074 | 查询方式有误                                                 |
| 103  | 300075 | 没有此发票请求流水号的信息                                   |
| 104  | 300076 | 发票类型代码与实际类型代码不符                               |
| 105  | 300077 | 该发票正在开具中，请稍后查询                                 |
| 106  | 300078 | 该发票开具失败                                               |
| 107  | 300079 | 参数错误或正在开票中                                         |
| 108  | 300080 | 作废人过长                                                   |
| 109  | 300081 | 该用户无可用商品编码                                         |
| 110  | 300082 | 起始号码与终止号码和剩余份数不一致                           |
| 111  | 300083 | 操作类型有误                                                 |
| 112  | 300084 | 发票打印中的获取该发票失败                                   |
| 113  | 300085 | 已作废发票不可打印                                           |
| 114  | 300086 | 无该发票打印业务信息(未发送\|正在打印中\|已过查询时间)       |
| 115  | 300087 | 红字发票校验核准金额节点不存在                               |
| 116  | 300088 | 编码字段与要求不符                                           |
| 117  | 300089 | 商品编码相关节点应该全部存在或不存在                         |
| 118  | 300090 | 使用优惠政策标识，增值税特殊管理不能为空                     |
| 119  | 300091 | 传入商品编码在局端不存在，请检查                             |
| 120  | 300092 | 优惠政策标识有误                                             |
| 121  | 300093 | 自行编码格式有误                                             |
| 122  | 300094 | 零税率标识有误                                               |
| 123  | 300095 | 已作废发票不可再次作废                                       |
| 124  | 300096 | 负数发票的原发票状态不为已开正数发票                         |
| 125  | 300097 | 购货单位识别号不能为空                                       |
| 126  | 300098 | 购货单位地址电话不能为空                                     |
| 127  | 300099 | 购货单位银行账号不能为空                                     |
| 128  | 300100 | 通知单编号格式有误                                           |
| 129  | 300101 | 该通知单编号已被使用                                         |
| 130  | 300102 | 专用发票零税率标识必须为空                                   |
| 131  | 300103 | 本行为被折扣行，下一行应为折扣行                             |
| 132  | 300104 | 可用税率不在可用范围内                                       |
| 133  | 300105 | 发票请求流水号字段有误                                       |
| 134  | 300106 | 开票终端标识字段有误                                         |
| 135  | 300107 | 非购方已抵扣，原发票代码号码不可以为空                       |
| 136  | 300108 | 申请税号与当前税号应该一致                                   |
| 137  | 300109 | 无可用电子平台                                               |
| 138  | 300110 | 电子平台名称为空                                             |
| 139  | 300111 | 该电子平台不可使用                                           |
| 140  | 300112 | 该税号无可用接入码                                           |
| 141  | 300113 | 折扣税额不得大于被折扣税额                                   |
| 142  | 300114 | 发送消息至百望电子票平台失败                                 |
| 143  | 300115 | 通过百旺电子平台每次只能获取一张发票的url                    |
| 144  | 300116 | 平台中无此发票的发票信息，不能获取url                        |
| 145  | 300117 | 税号格式有误                                                 |
| 146  | 300118 | 开票截至日期有误                                             |
| 147  | 300119 | 超过最大截至日期                                             |
| 148  | 300120 | 该发票已开具成功                                             |
| 149  | 300121 | 收票人手机号不能为空                                         |
| 150  | 300122 | 电子发票上传失败                                             |
| 151  | 300123 | 本条业务信息已被使用                                         |
| 152  | 300124 | 开票超时，请重新开具(发票请求流水号及业务信息与之前一致)     |
| 153  | 300125 | 获取抬头信息失败                                             |
| 154  | 300126 | 非减按征税税率不能为0.015                                    |
| 155  | 300127 | 税控已开发票作废，合计金额不能为空                           |
| 156  | 300128 | 税控电子票查询，只支持按发票请求流水号查询                   |
| 157  | 300129 | 税率不在可用范围内                                           |
| 158  | 300130 | 此开票终端(该税号下)个数有误(0个或多个)                      |
| 159  | 300131 | 该税控盘下已存在此开票终端标识                               |
| 160  | 300132 | 通过税控设备编号获取机身编号失败                             |
| 161  | 300133 | 税控服务器处理失败，返回错误原因为：                         |
| 162  | 300134 | 开票失败                                                     |
| 163  | 300135 | 扫开票未扫描                                                 |
| 164  | 300136 | 传入父节点无对应可用的商品编码                               |
| 165  | 300137 | 该商品名称已存在商品编码                                     |
| 166  | 300138 | 税控服务器阵列不支持此功能                                   |
| 167  | 300139 | 根据税号和设备编号获取税控设备信息失败                       |
| 168  | 300140 | 此开票终端(该税号下)已存在                                   |
| 169  | 300141 | 智能设备不支持此功能                                         |
| 170  | 300142 | 税控服务器不支持此功能                                       |
| 171  | 300143 | 此功能仅支持税控服务器                                       |
| 172  | 300144 | 红字信息表申请查询字段有误(申请原因\|申请人名称\|申请机构名称) |
| 173  | 300145 | 红字信息表申请非全部冲红，费用项目节点不可缺失               |
| 174  | 300146 | 开票终端管理时，企业信息相关节点有误(全传或全不传)           |
| 175  | 300147 | 开票终端管理时，企业信息设置失败，失败原因:                  |
| 176  | 300148 | 该设备不支持打印该票种                                       |
| 177  | 300149 | 设备等待开票数量达到上限,请稍后提交                          |
| 178  | 300150 | 注册码与税号不匹配有误                                       |
| 179  | 300151 | 该token不存在                                                |
| 180  | 300152 | 该token对应的税号不存在                                      |
| 181  | 300153 | 超过最大次数限制                                             |
| 182  | 300154 | 根据该发票请求流水号未查询到该发票                           |
| 183  | 300155 | 价税合计与原票不匹配                                         |
| 184  | 300156 | 传入商品编码简称与税局不符                                   |
| 185  | 300157 | 起始时间大于终止时间                                         |
| 186  | 300158 | 该查询方式下，查询条件有误                                   |
| 187  | 300159 | 未查询到发票                                                 |
| 188  | 300160 | 起始时间与终止时间不在同一月内                               |
| 189  | 300161 | 该父节点下子节点已达上限，不可继续添加                       |
| 190  | 300162 | 该根节点是汇总项,不可添加子节点                              |

